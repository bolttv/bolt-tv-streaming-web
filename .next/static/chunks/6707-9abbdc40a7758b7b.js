"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6707],{3857:(e,t,r)=>{r.d(t,{u:()=>i,z:()=>a});var n=r(3941);let s="bolt_tv_session_id";function i(){let e=localStorage.getItem(s);return e||(e=crypto.randomUUID(),localStorage.setItem(s,e)),e}async function a(){let e={"x-session-id":i()};try{if(!n.ND)return e;let{data:{session:t}}=await n.ND.auth.getSession();(null==t?void 0:t.access_token)&&(e.Authorization="Bearer ".concat(t.access_token))}catch(e){}return e}},3941:(e,t,r)=>{r.d(t,{E$:()=>o,ND:()=>a,Vf:()=>u,r7:()=>l});var n=r(2373);let s="https://dmbnsvghqluajdvdsmvu.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtYm5zdmdocWx1YWpkdmRzbXZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNDMxNTMsImV4cCI6MjA4NTcxOTE1M30.inNKGD8H3AEbYENVE8eyX64YkbK7r4ruG4xQXTFGoQw",a=s&&i?(0,n.UU)(s,i,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}):null;async function o(e){if(!a)return null;let{data:t,error:r}=await a.from("profiles").select("*").eq("id",e).single();return r?(console.error("Error fetching profile:",r),null):t}async function l(e,t){if(!a)return null;let{data:r,error:n}=await a.from("profiles").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();return n?(console.error("Error updating profile:",n),null):r}async function u(e,t,r){if(!a)return null;let{data:n,error:s}=await a.from("profiles").upsert({id:e,email:t,...r,updated_at:new Date().toISOString()},{onConflict:"id",ignoreDuplicates:!1}).select().single();return s?(console.error("Error upserting profile:",s),l(e,r)):n}},6707:(e,t,r)=>{r.d(t,{A:()=>c,O:()=>u});var n=r(5155),s=r(2115),i=r(3941),a=r(9453),o=r(3857);let l=(0,s.createContext)(void 0);function u(e){let{children:t}=e,[r,u]=(0,s.useState)(null),[c,d]=(0,s.useState)(null),[f,m]=(0,s.useState)(null),[h,g]=(0,s.useState)(!0),[p,y]=(0,s.useState)("email"),[w,v]=(0,s.useState)(null),[_,S]=(0,s.useState)(!1),[b,C]=(0,s.useState)(!1),I=(0,s.useRef)(!1);(0,s.useEffect)(()=>{let e=(0,a.fH)();e&&v(e)},[]);let N=!!r&&!!c,E=!!f&&"free"!==f.subscription_tier,D=(0,s.useCallback)(async e=>{if(!e.email)return;let t=(0,a.fH)();if((null==t?void 0:t.jwt)&&(null==t?void 0:t.email)===e.email){w||v(t);return}S(!0);try{let t=e.user_metadata||{},n=await (0,a.vr)(e.email,e.id,t.first_name,t.last_name);if(console.log("Cleeng SSO response received"),n.jwt){let s=n.customerId;console.log("Cleeng customer ID from response:",s);let o={id:s||e.email,email:n.email||e.email,jwt:n.jwt,refreshToken:n.refreshToken};(0,a.gM)(o),v(o);let l="free",u="none";try{var r;let t=await (0,a.X4)(s||e.email,n.jwt);console.log("Cleeng subscriptions response received");let i=(null==(r=t.responseData)?void 0:r.items)||t.items||[];if(i.length>0){let e=i.find(e=>"active"===e.status||"paid"===e.status);if(e){let t=e.offerId||"",r=e.period||"";console.log("Active subscription - offerId:",t,"period:",r),r.toLowerCase().includes("year")||r.toLowerCase().includes("annual")?u="annual":r.toLowerCase().includes("month")?u="monthly":t.toLowerCase().includes("annual")||t.toLowerCase().includes("yearly")?u="annual":t.toLowerCase().includes("monthly")&&(u="monthly"),l=t.toLowerCase().includes("premium")?"premium":"basic"}}}catch(e){console.error("Error fetching subscriptions:",e)}if(s){let r={cleeng_customer_id:s,subscription_tier:l,billing_period:u};t.first_name&&(r.first_name=t.first_name),t.last_name&&(r.last_name=t.last_name),t.gender&&(r.gender=t.gender),t.birth_year&&(r.birth_year=t.birth_year),t.zip_code&&(r.zip_code=t.zip_code),(t.first_name||t.last_name)&&(r.display_name=[t.first_name,t.last_name].filter(Boolean).join(" "));let n=await (0,i.Vf)(e.id,e.email,r);n&&m(n)}console.log("Cleeng customer linked successfully with ID:",s,"tier:",l,"billing:",u)}else n.errors&&console.error("Cleeng SSO error:",n.errors)}catch(e){console.error("Failed to link to Cleeng:",e)}finally{S(!1),C(!0)}},[w]);(0,s.useEffect)(()=>{if(!i.ND)return void g(!1);i.ND.auth.getSession().then(e=>{var t;let{data:{session:r}}=e;u(r),d(null!=(t=null==r?void 0:r.user)?t:null),(null==r?void 0:r.user)&&(y("authenticated"),(0,i.E$)(r.user.id).then(m)),g(!1)});let{data:{subscription:e}}=i.ND.auth.onAuthStateChange(async(e,t)=>{var r,n;console.log("Auth state changed:",e,null==t||null==(r=t.user)?void 0:r.email),u(t),d(null!=(n=null==t?void 0:t.user)?n:null),(null==t?void 0:t.user)?(y("authenticated"),(0,i.E$)(t.user.id).then(m)):(y("email"),m(null))});return()=>e.unsubscribe()},[]),(0,s.useEffect)(()=>{!N||!c||"authenticated"!==p||w||_||b||D(c)},[N,c,p,w,_,b,D]),(0,s.useEffect)(()=>{N&&(null==r?void 0:r.access_token)&&!I.current&&(I.current=!0,fetch("/api/migrate-watch-history",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r.access_token)},body:JSON.stringify({sessionId:(0,o.u)()})}).catch(()=>{}))},[N,r]),(0,s.useEffect)(()=>{!N&&w&&((0,a.Ef)(),v(null)),N||(I.current=!1)},[N,w]);let k=async(e,t,r)=>{try{var n;let s={password_set:!0};if((null==r?void 0:r.firstName)&&(s.first_name=r.firstName),(null==r?void 0:r.lastName)&&(s.last_name=r.lastName),(null==r?void 0:r.gender)&&(s.gender=r.gender),(null==r?void 0:r.birthYear)&&(s.birth_year=r.birthYear),(null==r?void 0:r.zipCode)&&(s.zip_code=r.zipCode),!i.ND)return{success:!1,error:"Authentication not configured"};let{data:a,error:o}=await i.ND.auth.signUp({email:e,password:t,options:{data:s}});if(o){if(o.message.toLowerCase().includes("already registered")||o.message.toLowerCase().includes("user already exists"))return{success:!1,error:"An account with this email already exists. Please sign in instead.",existingUser:!0};if(o.message.toLowerCase().includes("database error"))return console.error("Supabase signup database error:",o.message),{success:!1,error:"Unable to create account. Please try again."};return{success:!1,error:o.message}}if(a.user&&!a.session&&(null==(n=a.user.identities)?void 0:n.length)===0)return{success:!1,error:"An account with this email already exists. Please sign in instead.",existingUser:!0};return a.session&&(u(a.session),d(a.session.user),y("authenticated")),{success:!0}}catch(e){return{success:!1,error:"Failed to create account"}}},A=async(e,t)=>{try{if(!i.ND)return{success:!1,error:"Authentication not configured"};let{data:r,error:n}=await i.ND.auth.signInWithPassword({email:e,password:t});if(n)return{success:!1,error:n.message};if(r.session)return u(r.session),d(r.session.user),y("authenticated"),{success:!0};return{success:!1,error:"Sign in failed"}}catch(e){return{success:!1,error:"Failed to sign in"}}},j=async()=>{await (null===i.ND||void 0===i.ND?void 0:i.ND.auth.signOut()),u(null),d(null),m(null),y("email"),(0,a.Ef)(),v(null),C(!1)};return(0,n.jsx)(l.Provider,{value:{session:r,user:c,profile:f,isLoading:h,isAuthenticated:N,authStep:p,hasActiveSubscription:E,cleengCustomer:w,isLinking:_,linkFailed:b&&!w,retryLink:()=>{C(!1)},signUp:k,signIn:A,logout:j},children:t})}function c(){let e=(0,s.useContext)(l);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},9453:(e,t,r)=>{r.d(t,{$g:()=>d,Ef:()=>o,Sw:()=>l,X4:()=>c,fH:()=>a,gM:()=>i,vr:()=>u});let n="cleeng_customer",s="cleeng_auth_change";function i(e){localStorage.setItem(n,JSON.stringify(e)),window.dispatchEvent(new CustomEvent(s))}function a(){try{let e=localStorage.getItem(n);return e?JSON.parse(e):null}catch(e){return null}}function o(){localStorage.removeItem(n),window.dispatchEvent(new CustomEvent(s))}async function l(){let e=await fetch("/api/cleeng/offers");if(!e.ok)throw Error("Failed to fetch offers");let t=await e.json();return Array.isArray(t)?t:[]}async function u(e,t,r,n){return(await fetch("/api/cleeng/sso",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,externalId:t,firstName:r,lastName:n})})).json()}async function c(e,t){return(await fetch("/api/cleeng/subscriptions/".concat(e),{headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)}})).json()}function d(e,t){return new Intl.NumberFormat("en-US",{style:"currency",currency:t||"USD"}).format(e)}}}]);