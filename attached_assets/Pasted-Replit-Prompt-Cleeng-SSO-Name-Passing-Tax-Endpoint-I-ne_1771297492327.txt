Replit Prompt: Cleeng SSO Name Passing + Tax Endpoint
I need to make changes across 4 files to accomplish two things:

Pass first/last name from Supabase auth metadata through to Cleeng SSO registration
Add a tax calculation endpoint and display tax breakdown in the checkout order summary

Here are the exact changes needed:

File 1: client/src/lib/cleeng.ts
Change A: Update ssoLogin function signature to accept firstName and lastName
Find the ssoLogin function and update it to:
typescriptexport async function ssoLogin(email: string, externalId?: string, firstName?: string, lastName?: string) {
  const response = await fetch("/api/cleeng/sso", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, externalId, firstName, lastName }),
  });
  return response.json();
}
Change B: Add TaxInfo type and getTaxInfo function at the end of the file
Add this after the existing getCleengCheckoutUrl function:
typescriptexport interface TaxInfo {
  taxRate: number;
  taxAmount: number;
  priceExclTax: number;
  priceInclTax: number;
  currency: string;
}

export async function getTaxInfo(offerId: string): Promise<TaxInfo | null> {
  try {
    const response = await fetch("/api/cleeng/tax", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ offerId }),
    });
    if (!response.ok) return null;
    return response.json();
  } catch {
    return null;
  }
}

File 2: client/src/lib/AuthContext.tsx
Change: Update linkToCleeng to pass firstName/lastName from user metadata to Cleeng SSO
Inside the linkToCleeng function, find the call to ssoLogin. It currently looks like:
typescriptconst response = await ssoLogin(currentUser.email, currentUser.id);
Replace it with:
typescriptconst metadata = currentUser.user_metadata || {};
const response = await ssoLogin(
  currentUser.email,
  currentUser.id,
  metadata.first_name,
  metadata.last_name
);

File 3: server/routes.ts
Change A: Update the SSO endpoint to accept and forward firstName/lastName
In the /api/cleeng/sso POST handler, find where req.body is destructured:
typescriptconst { email, externalId } = req.body;
Change it to:
typescriptconst { email, externalId, firstName, lastName } = req.body;
Then in the same handler, find the customerData object inside the registerCustomer JSON-RPC call. Add firstName and lastName to it:
typescriptcustomerData: {
  email,
  password: randomPassword,
  locale: "en_US",
  country: "US",
  currency: "USD",
  externalId: externalId || email,
  firstName: firstName || "",
  lastName: lastName || "",
}
Also add a log line after the existing SSO log:
typescriptconsole.log("Cleeng SSO request for email:", email, "firstName:", firstName, "lastName:", lastName);
Change B: Add new /api/cleeng/tax POST endpoint
Add this new endpoint AFTER the /api/cleeng/checkout handler and BEFORE the /api/cleeng/webhook handler:
typescript// Tax calculation endpoint - gets offer details with IP-based tax from Cleeng
app.post("/api/cleeng/tax", async (req, res) => {
  try {
    const { offerId } = req.body;

    if (!offerId) {
      return res.status(400).json({ error: "Offer ID is required" });
    }

    if (!CLEENG_API_SECRET) {
      return res.status(500).json({ error: "Cleeng API not configured" });
    }

    // Get client IP for tax jurisdiction lookup
    const clientIp = (req.headers["x-forwarded-for"] as string)?.split(",")[0]?.trim()
      || req.socket.remoteAddress
      || "";

    console.log("Tax calculation request - offerId:", offerId, "clientIp:", clientIp);

    const response = await fetch(`${CLEENG_CORE_API_URL}/3.0/json-rpc`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        method: "getOfferDetails",
        params: {
          publisherToken: CLEENG_API_SECRET,
          offerId: offerId,
          customerIP: clientIp,
        },
        jsonrpc: "2.0",
        id: 1,
      }),
    });

    const data = await response.json();
    console.log("Cleeng tax/offer response:", JSON.stringify(data, null, 2));

    if (data.error) {
      return res.status(400).json({ error: data.error.message || "Failed to get offer details" });
    }

    const result = data.result;
    if (result) {
      const priceExclTax = result.customerPriceExclTax ?? result.offerPrice ?? 0;
      const priceInclTax = result.customerPriceInclTax ?? result.offerPrice ?? 0;
      const taxAmount = priceInclTax - priceExclTax;
      const taxRate = result.taxRate ?? 0;

      res.json({
        taxRate,
        taxAmount: Math.max(0, parseFloat(taxAmount.toFixed(2))),
        priceExclTax: parseFloat(priceExclTax.toFixed(2)),
        priceInclTax: parseFloat(priceInclTax.toFixed(2)),
        currency: result.customerCurrency || result.offerCurrency || "USD",
      });
    } else {
      res.status(400).json({ error: "No offer details returned" });
    }
  } catch (error) {
    console.error("Tax calculation error:", error);
    res.status(500).json({ error: "Failed to calculate tax" });
  }
});

File 4: client/src/pages/Checkout.tsx
Change A: Update imports
Update the cleeng import line to include the new exports:
typescriptimport { getOffers, CleengOffer, formatPrice, getTaxInfo, TaxInfo } from "@/lib/cleeng";
Change B: Add tax state variables
After the existing appliedPromo state declaration, add:
typescript// Tax info state
const [taxInfo, setTaxInfo] = useState<TaxInfo | null>(null);
const [taxLoading, setTaxLoading] = useState(false);
Change C: Add showTax computed variable
After the offerId declaration, add:
typescriptconst showTax = taxInfo && (taxInfo.taxAmount > 0 || taxInfo.priceInclTax > taxInfo.priceExclTax);
Change D: Add useEffect to fetch tax info
After the existing useEffect that fetches the offer, add a new useEffect:
typescript// Fetch tax info when offer is loaded
useEffect(() => {
  if (!offer || !offerId) return;

  const fetchTax = async () => {
    setTaxLoading(true);
    try {
      const resolvedOfferId = offer.longId || offer.id || offerId;
      const info = await getTaxInfo(resolvedOfferId);
      if (info) {
        setTaxInfo(info);
      }
    } catch (err) {
      console.error("Failed to fetch tax info:", err);
    } finally {
      setTaxLoading(false);
    }
  };

  fetchTax();
}, [offer, offerId]);
Change E: Add price computation variables
Before the return statement (after const hasFieldErrors = ...), add:
typescript// Compute display prices using server-provided tax values
const displayCurrency = taxInfo?.currency || offer?.price.currency || "USD";
const subtotalPrice = appliedPromo?.discount?.discountedPrice ?? (taxInfo?.priceExclTax ?? offer?.price.amount ?? 0);
const taxAmount = taxInfo?.taxAmount ?? 0;
const totalPrice = showTax
  ? subtotalPrice + taxAmount
  : (appliedPromo?.discount?.discountedPrice ?? offer?.price.amount ?? 0);
Change F: Update Order Summary section
Replace the existing order summary price display (the section after the billing/free trial rows and before the promo code section) with this tax-aware breakdown:
jsx{/* Price breakdown with tax */}
<div className="space-y-2 mb-2">
  {/* Subtotal row - show when tax applies or promo applied */}
  {(showTax || appliedPromo) && (
    <div className="flex justify-between items-center text-sm">
      <span className="text-gray-400">Subtotal</span>
      <span className="text-gray-300">
        {appliedPromo ? (
          <>
            <span className="line-through text-gray-500 mr-2">
              {formatPrice(taxInfo?.priceExclTax ?? offer.price.amount, displayCurrency)}
            </span>
            {formatPrice(appliedPromo.discount.discountedPrice, displayCurrency)}
          </>
        ) : (
          formatPrice(taxInfo?.priceExclTax ?? offer.price.amount, displayCurrency)
        )}
      </span>
    </div>
  )}

  {/* Tax row - only when there's actual tax */}
  {showTax && (
    <div className="flex justify-between items-center text-sm">
      <span className="text-gray-400">
        Tax{taxInfo?.taxRate ? ` (${(taxInfo.taxRate * 100).toFixed(1)}%)` : ""}
      </span>
      <span className="text-gray-300">
        {taxLoading ? (
          <Loader2 className="w-3 h-3 animate-spin inline" />
        ) : (
          formatPrice(taxAmount, displayCurrency)
        )}
      </span>
    </div>
  )}

  {/* Promo discount row (when no tax breakdown) */}
  {appliedPromo && !showTax && (
    <div className="flex justify-between items-center text-sm">
      <span className="text-gray-400">Discount ({appliedPromo.discount.discountPercent}%)</span>
      <span className="text-green-400">
        -{formatPrice(
          (taxInfo?.priceExclTax ?? offer.price.amount) - appliedPromo.discount.discountedPrice,
          displayCurrency
        )}
      </span>
    </div>
  )}
</div>

{/* Total */}
<div className="flex justify-between items-center py-3 border-t border-gray-700">
  <span className="text-gray-400">
    {offer.freeDays && offer.freeDays > 0 ? "Due today" : "Total"}
  </span>
  <span className="text-2xl font-bold">
    {offer.freeDays && offer.freeDays > 0 ? (
      "$0.00"
    ) : (
      formatPrice(totalPrice, displayCurrency)
    )}
  </span>
</div>

{offer.freeDays && offer.freeDays > 0 && (
  <p className="text-xs text-gray-500 mt-2">
    Then {formatPrice(showTax ? (taxInfo?.priceInclTax ?? offer.price.amount) : offer.price.amount, displayCurrency)}/{offer.billingCycle?.periodUnit || "month"} after trial ends
    {showTax && " (tax included)"}
  </p>
)}
Also update the subscribe button text to use the computed totalPrice and displayCurrency:
jsx{offer?.freeDays && offer.freeDays > 0 
  ? `Start ${offer.freeDays}-Day Free Trial`
  : `Subscribe - ${formatPrice(totalPrice, displayCurrency)}`
}

Do NOT change any other files. Do NOT modify any existing functionality beyond what's described above. Make sure all imports are correct after the changes.